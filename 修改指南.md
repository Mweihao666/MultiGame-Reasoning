# 环境提取修改指南

## 一、需要修改的文件和位置

### 1.1 base.py 中的路径修改

**文件位置**：`ragen/env/base.py`

**需要修改的地方**：

#### 修改1：API密钥文件路径（第45行）
```python
# 原代码：
keys = json.load(open('ragen/env/api-keys.json'))

# 修改为：
import os
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
keys = json.load(open(os.path.join(BASE_DIR, 'api-keys.json')))
```

**说明**：使用相对路径，确保无论在哪里运行都能找到`api-keys.json`文件。

---

### 1.2 undercover/env.py 中的路径修改

**文件位置**：`ragen/env/undercover/env.py`

#### 修改1：wordlist文件路径（第43行）
```python
# 原代码：
with open(f"ragen/env/undercover/{self.config.wordlist}", "r") as f:
    self.wordlist = json.load(f)

# 修改为：
import os
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
with open(os.path.join(BASE_DIR, self.config.wordlist), "r") as f:
    self.wordlist = json.load(f)
```

**说明**：使用相对路径读取词汇列表文件。

---

### 1.3 导入路径修改

#### 1.3.1 tictactoe/env.py

**文件位置**：`ragen/env/tictactoe/env.py`

**需要修改的导入**（第7-8行）：
```python
# 原代码：
from ragen.env.base import BaseDiscreteActionEnv, EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from ragen.env.env_factory import create_env_player_for_config

# 修改为（方案1：相对导入，如果base.py和env_factory.py在同一目录）：
from ..base import BaseDiscreteActionEnv, EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from ..env_factory import create_env_player_for_config

# 或者（方案2：绝对导入，如果重新组织目录结构）：
from env.base import BaseDiscreteActionEnv, EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from env.env_factory import create_env_player_for_config
```

#### 1.3.2 undercover/env.py

**文件位置**：`ragen/env/undercover/env.py`

**需要修改的导入**（第11-12行）：
```python
# 原代码：
from ragen.env.base import BaseLanguageBasedEnv, EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from ragen.env.env_factory import create_env_player_for_config

# 修改为（方案1：相对导入）：
from ..base import BaseLanguageBasedEnv, EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from ..env_factory import create_env_player_for_config

# 或者（方案2：绝对导入）：
from env.base import BaseLanguageBasedEnv, EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from env.env_factory import create_env_player_for_config
```

**注意**：`undercover/env.py`中虽然导入了`BaseLanguageBasedEnv`，但实际继承的是`MultiGameEnv`，所以这个导入可以删除。

---

### 1.4 env_factory.py 中的导入修改

**文件位置**：`ragen/env/env_factory.py`

**需要修改的导入**（第2行）：
```python
# 原代码：
from .base import EnvPlayer, SuccessRate

# 如果base.py在同一目录，保持不变
# 如果重新组织目录，可能需要修改为：
from env.base import EnvPlayer, SuccessRate
# 或
from base import EnvPlayer, SuccessRate
```

---

## 二、目录结构建议

### 方案A：保持相对导入（推荐）

```
extracted_envs/
├── base.py              # 从 ragen/env/base.py 复制
├── env_factory.py       # 从 ragen/env/env_factory.py 复制
├── api-keys.json        # 从 ragen/env/api-keys.json 复制（需要配置）
├── tictactoe/
│   ├── __init__.py
│   ├── env.py           # 导入改为：from ..base import ...
│   └── config.py
└── undercover/
    ├── __init__.py
    ├── env.py           # 导入改为：from ..base import ...
    ├── config.py
    └── wordlists_easy.json
```

**导入方式**：
```python
# tictactoe/env.py
from ..base import BaseDiscreteActionEnv, ...
from ..env_factory import create_env_player_for_config

# undercover/env.py
from ..base import MultiGameEnv, ...
from ..env_factory import create_env_player_for_config
```

### 方案B：扁平化结构（简单但不够优雅）

```
extracted_envs/
├── base.py
├── env_factory.py
├── api-keys.json
├── tictactoe_env.py     # 重命名并修改导入
├── tictactoe_config.py
├── undercover_env.py    # 重命名并修改导入
├── undercover_config.py
└── wordlists_easy.json
```

**导入方式**：
```python
# tictactoe_env.py
from base import BaseDiscreteActionEnv, ...
from env_factory import create_env_player_for_config

# undercover_env.py
from base import MultiGameEnv, ...
from env_factory import create_env_player_for_config
```

### 方案C：包结构（最规范）

```
extracted_envs/
├── __init__.py
├── base.py
├── env_factory.py
├── api-keys.json
├── tictactoe/
│   ├── __init__.py
│   ├── env.py
│   └── config.py
└── undercover/
    ├── __init__.py
    ├── env.py
    ├── config.py
    └── wordlists_easy.json
```

**导入方式**：
```python
# 在extracted_envs/__init__.py中
from .base import *
from .env_factory import *

# tictactoe/env.py
from ..base import BaseDiscreteActionEnv, ...
from ..env_factory import create_env_player_for_config
```

---

## 三、具体修改步骤

### 步骤1：创建目录结构
```bash
mkdir -p extracted_envs/{tictactoe,undercover}
```

### 步骤2：复制文件
```bash
# 复制基础文件
cp ragen/env/base.py extracted_envs/
cp ragen/env/env_factory.py extracted_envs/
cp ragen/env/api-keys.json extracted_envs/

# 复制tictactoe环境
cp -r ragen/env/tictactoe/* extracted_envs/tictactoe/

# 复制undercover环境
cp -r ragen/env/undercover/* extracted_envs/undercover/
```

### 步骤3：修改base.py
在`extracted_envs/base.py`中：
1. 找到第45行：`keys = json.load(open('ragen/env/api-keys.json'))`
2. 替换为：
```python
import os
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
keys = json.load(open(os.path.join(BASE_DIR, 'api-keys.json')))
```

### 步骤4：修改undercover/env.py
在`extracted_envs/undercover/env.py`中：
1. 找到第43行：`with open(f"ragen/env/undercover/{self.config.wordlist}", "r") as f:`
2. 替换为：
```python
import os
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
with open(os.path.join(BASE_DIR, self.config.wordlist), "r") as f:
```

3. 修改导入（第11-12行）：
```python
# 删除不需要的导入
# from ragen.env.base import BaseLanguageBasedEnv, ...  # BaseLanguageBasedEnv未使用

# 修改为
from ..base import EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from ..env_factory import create_env_player_for_config
```

### 步骤5：修改tictactoe/env.py
在`extracted_envs/tictactoe/env.py`中：
1. 修改导入（第7-8行）：
```python
from ..base import BaseDiscreteActionEnv, EnvPlayer, seed_everything, timed, MultiGameEnv, Simplifier
from ..env_factory import create_env_player_for_config
```

### 步骤6：配置api-keys.json
编辑`extracted_envs/api-keys.json`，填入真实的API密钥：
```json
{
    "deepseek": ["your_deepseek_key1", "your_deepseek_key2"],
    "openrouter": ["your_openrouter_key1"],
    "dmx": ["your_dmx_key1"]
}
```

---

## 四、验证测试

### 测试脚本示例

创建`test_extracted_envs.py`：

```python
import sys
sys.path.insert(0, 'extracted_envs')

from tictactoe.env import TicTacToeEnv
from tictactoe.config import TicTacToeEnvConfig
from undercover.env import UndercoverEnv
from undercover.config import UndercoverEnvConfig

# 测试TicTacToe
print("Testing TicTacToe...")
config = TicTacToeEnvConfig()
env = TicTacToeEnv(config)
obs = env.reset(seed=42)
print("TicTacToe reset successful!")
print(f"Observation: {obs[:100]}...")

# 测试Undercover
print("\nTesting Undercover...")
config = UndercoverEnvConfig()
env = UndercoverEnv(config)
obs = env.reset(seed=42)
print("Undercover reset successful!")
print(f"Observation: {obs[:100]}...")
```

运行测试：
```bash
python test_extracted_envs.py
```

---

## 五、常见问题处理

### 问题1：ImportError: No module named 'ragen'
**原因**：导入路径未修改
**解决**：检查所有`from ragen.env`是否已改为相对导入或新路径

### 问题2：FileNotFoundError: api-keys.json
**原因**：路径硬编码，找不到文件
**解决**：使用`os.path.join(BASE_DIR, 'api-keys.json')`相对路径

### 问题3：FileNotFoundError: wordlists_easy.json
**原因**：undercover环境找不到词汇列表文件
**解决**：确保文件在`undercover/`目录下，并使用相对路径读取

### 问题4：AttributeError: 'EnvPlayer' object has no attribute 'act'
**原因**：EnvPlayer类未正确导入或初始化
**解决**：检查`env_factory.py`是否正确导入`EnvPlayer`类

---

## 六、完整修改检查清单

- [ ] `base.py`中`api-keys.json`路径已修改为相对路径
- [ ] `undercover/env.py`中`wordlist`文件路径已修改为相对路径
- [ ] `tictactoe/env.py`中导入已修改
- [ ] `undercover/env.py`中导入已修改
- [ ] `env_factory.py`中导入正确（如果base.py在同一目录，通常不需要修改）
- [ ] `api-keys.json`文件已配置真实密钥
- [ ] `wordlists_easy.json`文件已复制到`undercover/`目录
- [ ] 所有`__init__.py`文件正确导出类
- [ ] 测试脚本可以成功导入和运行

---

## 七、额外注意事项

1. **API密钥安全**：
   - 不要将包含真实密钥的`api-keys.json`提交到Git
   - 可以创建`api-keys.json.example`作为模板

2. **模型路径配置**：
   - 如果使用本地vLLM模型，确保`config.py`中的`model_path`正确
   - 确保端口号配置正确

3. **依赖库**：
   - 确保安装了`openai`、`numpy`、`gymnasium`等依赖
   - 检查Python版本兼容性

4. **线程安全**：
   - `EnvPlayer`使用了线程安全的密钥轮换，多线程环境下应该没问题

5. **错误处理**：
   - API调用有超时和重试机制，但需要确保网络连接正常

