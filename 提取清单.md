# RAGEN环境提取清单

## 任务目标
从RAGEN框架中提取两个环境：`tictactoe`（井字棋）和 `undercover`（谁是卧底），用于独立使用。

---

## 一、需要提取的核心文件

### 1.1 TicTacToe环境（井字棋）
```
ragen/env/tictactoe/
├── __init__.py          # 导出TicTacToeEnv和TicTacToeEnvConfig
├── env.py               # 主环境实现文件
└── config.py            # 环境配置类
```

### 1.2 Undercover环境（谁是卧底）
```
ragen/env/undercover/
├── __init__.py          # 导出UndercoverEnv和UndercoverEnvConfig
├── env.py               # 主环境实现文件
├── config.py            # 环境配置类
├── wordlists_easy.json   # 词汇列表（必需）
├── wordlists.json       # 词汇列表（可选）
├── wordlist_grok.json   # 词汇列表（可选）
└── wordshuffle.json     # 词汇列表（可选）
```

### 1.3 基础依赖文件
```
ragen/env/
├── base.py              # 基础类定义（必需）
│   ├── BaseDiscreteActionEnv  # TicTacToe继承自此类
│   ├── BaseLanguageBasedEnv   # Undercover继承自此类
│   ├── MultiGameEnv           # Undercover继承自此类
│   ├── EnvPlayer              # 对手模型调用类（核心）
│   ├── Simplifier             # 对话历史简化类
│   ├── seed_everything()      # 随机种子设置函数
│   └── timed()                # 计时装饰器
└── env_factory.py       # 环境玩家工厂函数（必需）
    ├── create_env_player_for_config()  # 创建EnvPlayer的便捷函数
    ├── get_env_player()                # 获取EnvPlayer实例（带缓存）
    └── create_success_info()           # 创建成功率统计
```

### 1.4 API密钥文件（必需）
```
ragen/env/
└── api-keys.json        # API密钥配置
    {
        "deepseek": ["key1", "key2", ...],
        "openrouter": ["key1", "key2", ...],
        "dmx": ["key1", "key2", ...]
    }
```

---

## 二、依赖关系分析

### 2.1 TicTacToe环境的依赖
```python
# env.py中的导入
from ragen.env.base import (
    BaseDiscreteActionEnv,  # 基础类
    EnvPlayer,              # 对手模型调用（通过env_factory使用）
    seed_everything,        # 工具函数
    timed,                  # 装饰器
    MultiGameEnv,           # 未直接使用，但base.py中定义
    Simplifier              # 未直接使用，但base.py中定义
)
from ragen.env.env_factory import create_env_player_for_config  # 创建对手玩家
```

### 2.2 Undercover环境的依赖
```python
# env.py中的导入
from ragen.env.base import (
    BaseLanguageBasedEnv,   # 基础类（但实际继承MultiGameEnv）
    EnvPlayer,              # 对手模型调用（通过env_factory使用）
    seed_everything,        # 工具函数
    timed,                  # 装饰器
    MultiGameEnv,           # 实际继承的基类
    Simplifier              # 对话历史简化（实际使用）
)
from ragen.env.env_factory import create_env_player_for_config  # 创建对手玩家
```

### 2.3 base.py的内部依赖
```python
# base.py中的导入和依赖
import json                  # 读取api-keys.json
from openai import OpenAI    # API调用
import numpy as np          # 数值计算
import random               # 随机数
import threading            # 线程安全
```

### 2.4 env_factory.py的依赖
```python
# env_factory.py中的导入
from .base import EnvPlayer, SuccessRate  # 依赖base.py
```

---

## 三、需要修改的路径和导入

### 3.1 导入路径修改

#### 当前导入（在RAGEN框架内）：
```python
from ragen.env.base import ...
from ragen.env.env_factory import ...
```

#### 修改后（独立使用）：
```python
# 方案1：保持相对导入（推荐）
from .base import ...
from .env_factory import ...

# 方案2：绝对导入（需要调整目录结构）
from env.base import ...
from env.env_factory import ...
```

### 3.2 文件路径修改

#### base.py中的路径：
```python
# 当前：硬编码路径
keys = json.load(open('ragen/env/api-keys.json'))

# 修改为：相对路径或配置路径
import os
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
keys = json.load(open(os.path.join(BASE_DIR, 'api-keys.json')))
```

#### undercover/env.py中的路径：
```python
# 当前：硬编码路径
with open(f"ragen/env/undercover/{self.config.wordlist}", "r") as f:
    self.wordlist = json.load(f)

# 修改为：相对路径
import os
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
with open(os.path.join(BASE_DIR, self.config.wordlist), "r") as f:
    self.wordlist = json.load(f)
```

---

## 四、目录结构建议

### 4.1 提取后的目录结构
```
extracted_envs/
├── base.py                    # 从ragen/env/base.py复制
├── env_factory.py             # 从ragen/env/env_factory.py复制
├── api-keys.json              # 从ragen/env/api-keys.json复制（需要配置）
├── tictactoe/
│   ├── __init__.py
│   ├── env.py                 # 需要修改导入路径
│   └── config.py
└── undercover/
    ├── __init__.py
    ├── env.py                 # 需要修改导入路径和文件路径
    ├── config.py
    └── wordlists_easy.json    # 必需数据文件
```

---

## 五、关键功能说明

### 5.1 EnvPlayer类（对手模型调用）
- **位置**：`base.py`中的`EnvPlayer`类
- **功能**：调用对手模型（支持多种API：deepseek, openrouter, dmx, 本地vLLM）
- **使用方式**：通过`env_factory.create_env_player_for_config(config)`创建
- **关键方法**：`act(message, player_id)` - 获取对手的动作

### 5.2 环境配置
- **TicTacToeConfig**：包含`player_info`列表，指定对手模型信息
- **UndercoverConfig**：包含`player_info`列表，指定多个对手模型信息

### 5.3 API密钥管理
- 需要配置`api-keys.json`文件
- 支持多密钥轮换（ThreadSafeCycle）
- 支持超时和重试机制

---

## 六、需要处理的琐碎事项

### 6.1 路径相关
- [ ] 修改`base.py`中`api-keys.json`的读取路径
- [ ] 修改`undercover/env.py`中`wordlist`文件的读取路径
- [ ] 统一使用`os.path`处理路径，避免硬编码

### 6.2 导入相关
- [ ] 修改`tictactoe/env.py`中的导入语句
- [ ] 修改`undercover/env.py`中的导入语句
- [ ] 确保`__init__.py`文件正确导出类

### 6.3 配置相关
- [ ] 创建`api-keys.json`配置文件模板
- [ ] 检查`wordlists_easy.json`等数据文件是否完整
- [ ] 验证配置类的默认值是否合理

### 6.4 依赖检查
- [ ] 确认所有Python标准库依赖（json, os, random, numpy等）
- [ ] 确认第三方库依赖（openai, gymnasium等）
- [ ] 检查是否有其他隐藏依赖

### 6.5 测试相关
- [ ] 创建简单的测试脚本验证环境可用性
- [ ] 测试对手模型调用是否正常
- [ ] 验证环境reset/step/render功能

---

## 七、提取步骤建议

1. **创建新目录结构**
   ```bash
   mkdir -p extracted_envs/{tictactoe,undercover}
   ```

2. **复制核心文件**
   - 复制`base.py`和`env_factory.py`到根目录
   - 复制`tictactoe/`和`undercover/`目录

3. **修改导入路径**
   - 批量替换`from ragen.env`为相对导入或新路径

4. **修改文件路径**
   - 使用`os.path`处理所有文件路径

5. **配置API密钥**
   - 创建`api-keys.json`并填入密钥

6. **测试验证**
   - 编写简单测试脚本验证功能

---

## 八、注意事项

1. **API密钥安全**：不要将`api-keys.json`提交到版本控制
2. **模型路径**：如果使用本地vLLM模型，需要确保端口和路径正确
3. **依赖版本**：注意`openai`库的版本兼容性
4. **线程安全**：`EnvPlayer`使用了线程安全的密钥轮换机制
5. **错误处理**：注意API调用的超时和重试逻辑

---

## 九、快速检查清单

提取完成后，检查以下项目：

- [ ] 所有文件路径使用相对路径或`os.path`
- [ ] 所有导入语句正确修改
- [ ] `api-keys.json`文件存在且格式正确
- [ ] `wordlists_easy.json`等数据文件存在
- [ ] `__init__.py`文件正确导出类
- [ ] 可以成功导入环境类
- [ ] 可以成功创建环境实例
- [ ] 可以成功调用对手模型
- [ ] 环境reset/step/render功能正常

